# Manipulando Data Frames com `dplyr`

## Data Frames

## O Pacote `dplyr` 

O pacote `dplyr` foi desenvolvido por Hadley Wickham, cientista chefe do RStudio. É uma versão otimizada do pacote `plyr`. O pacote `dplyr` não fornece nenhuma funcionalidade "nova" ao R, pois já é feito com base no R, mas simplifica **bastante** a funcionalidade no R.

Uma contribuição importante do `dplyr` é que ele fornece uma "gramática" (em particular, verbos) para manipulação 

## Gramática do `dplyr`

Alguns dos principais "verbos" fornecidos pelo `dplyr` são:

  -`select`: retorna um subconjunto das colunas de um data.frames, usando uma notação flexível;
  
  -`filter`: extrair um subconjunto de linhas(observações) de um data.frames com base em condições lógicas;
  
  -`arrange`: reordenar linhas de um data.frames;
  
  -`rename`: renomear variáveis em um data.frames;
  
  -`mutate`: adiciona novas variáveis/colunas ou transforme variáveis existentes;
  
  -`summarise/summarize`: gera estatísticas resumidas de diferentes variáveis no data.frames, possivelmente dentro dos estratos.
  
## Propriedades das funções do `dplyr`

As funções têm algumas características comuns:

  -1.O primeiro argumento é um data.frames;
  
  -2.Os argumentos subsequentes descrevem o que fazer com o data.frames especificado no primeiro argumento;
  
  -3.O resultado de retorno de uma função é um novo data.frames;
  
  -4.Os data.frames devem devidamente formatados e anotados para que tudo isso seja útil. Em particular, os dados devem estar *organizados*.
  
## Instalando o Pacote `dplyr`

O pacote pode ser instalado a partir do CRAN ou do GitHub usando o pacote `devtools` com a função `install_github()`. O repositório GitHub normalmente contém as versões mais atualizadas dos pacotes.

Para instalar a partir do CRAN, bastar executar:

````{r script4.1, eval=FALSE}
install.packages("dplyr")
```

Para instalar a partir do GitHub, execute:

```{r script4.2, eval=FALSE}
library(devtools) #carregar o pacote 'devtools' antes.
devtools::install_github("hadley/dplyr")
```

Após a instalação do pacote, carregá-lo com a função `library()`:

```{r script4.3}
library(dplyr)
```

Ao carregar o pacote você pode receber alguns avisos, porque há funções no `dplyr`que têm o mesmo nome que as funções em outros pacotes. Por enquanto pode ignorar os avisos.

## `select()`

Para melhor apresentar as funcionalidades da função, usaremos um conjunto de dados contendo dados de poluição do ar e temperatura da [cidade de Chicago](http://www.biostat.jhsph.edu/~rpeng/leanpub/rprog/chicago_data.zip) nos EUA. 

Após descompactar o arquivo, você pode carregar os dados no R usando a função `readRDS()`:

```{r script4.4}
chicago <- readRDS("data/chicago.rds")
```

Este banco de chicago encontra no seguinte endereço <http://www.biostat.jhsph.edu/~rpeng/leanpub/rprog/chicago_data.zip> e está zipado. Uma das formas para facilitar o processo de descompactação do arquivo pelo R é:

```{r eval=FALSE}
# objeto caracter.
fileURL <- "http://www.biostat.jhsph.edu/~rpeng/leanpub/rprog/chicago_data.zip"

#Esta função pode ser usada para baixar um arquivo da Internet.
download.file(fileURL, destfile = "data/chicago.rds", method = "curl", extra='-L') 
```

Umas das formas de ter informações do seu banco de dados é utilizar as seguintes funções `dim()` e `str()`. A primeira especifica a dimensão do seu banco e a segunda a estrutura do seu banco de dados.

```{r script4.5}
dim(chicago)
str(chicago)
```

Muitas vezes teremos um data.frames contendo um grande número de dados. Com isso, a função `select()` permite obter as poucas colunas que você pode precisar.

Suponhamos que desejássemos pegar as 3 primeiras colunas. Há algumas maneiras de fazer isto. Poderíamos, por exemplo, usar o índices númericos. Mas também podemos usar os nomes diretamente. 

```{r script4.6}
names(chicago[1:3]) 
subset1 <- select(chicago, city:dptp)
head(subset1)
```

Normalmente `:` não pode ser usado com nomes ou sequências de caracteres, mas dentro da função `select()` pode usá-lo para especificar um intervalo de nomes de variáveis.

Pode **omitir** variáveis usando a função `select()` usando o sinal negativo.

```{r script4.7}
subset2 <- select(chicago, -(city:dptp))
head(subset2)
```

o que indica que estamos incluindo todas as variáveis, exceto as variáveis `city` até `dptp`.

O código equivalente ao anterior sem o uso do pacote seria:

```{r}
i <- match("city", names(chicago))
j <- match("dptp", names(chicago))
head(chicago[, -(i:j)])
```

A função de correspondência `mathc()` retorna um vetor das posições das (primeiras) correspondências de seu primeiro argumento no segundo. De acordo com a [Documentação R](https://stat.ethz.ch/R-manual/R-devel/library/base/html/match.html), a função é equivalente ao operador `%in%` que indica se uma correspondência foi localizada para o vetor1 no vetor2. O valor do resultado será VERDADEIRO ou FALSO, mas nunca NA. Portanto, o operador `%in%` pode ser útil em condições `if`.

Exemplos:

```{r}
#função math().
v1 <- c("a1","b2","c1","d2")
v2 <- c("g1","x2","d2","e2","f1","a1","c2","b2","a2")
x <- match(v1,v2)
x

#com o operador %in%.
v1 <- c("a1","b2","c1","d2")
v2 <- c("g1","x2","d2","e2","f1","a1","c2","b2","a2")
v1 %in% v2
```

A função `select()` permite uma sintaxe especial que especifica nomes de variáveis com base em padrões. Por exemplo, há várias funções auxiliares que você pode usar:

    1.`starts_with("abc")`: corresponde aos nomes que começam com "abc";

```{r}
#Queremos manter todas as variáveis que começam com um "d":
subset3 <- select(chicago, starts_with("d"))
str(subset3)
```

    2.`ends_with("xyz")`: corresponde aos nomes que terminam com "xyz";

```{r}
subset4 <- select(chicago, ends_with("2"))
str(subset4)
```

    3.`contains("ijk")`: corresponde aos nomes que contêm "ijk";

```{r}
subset5 <- select(chicago, contains("tmean"))
head(subset5)
```
  
    4.`matches("(.)\\1")`: selecionar variáveis que correspondem a uma expressão regular. Esta corresponde a qualquer variável que contenha caracteres repetidos. Você aprenderá mais sobre expressões regulares em [strings]().

```{r}
subset6 <- select(chicago, matches(c("tm"), names(chicago)))
head(subset6)
```
  
    5.`num_range("x", 1:3)`: Corresponde x1, x2 e x3.

```{r}

```

Você também pode usar expressões regulares mais gerais, se necessário. Veja a página de ajuda (?select) para mais detalhes.

`select()` pode ser usado para renomear variáveis, mas raramente é útil porque descarta todas as variáveis não mencionadas explicitamente. Em vez disso, use `rename()`, que é uma variante de `select()` que mantém todas as variáveis que não são mencionadas explicitamente.

## Exercícios

